<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Market Insights - Live Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', 'Consolas', monospace;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 15px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            margin-bottom: 20px;
        }
        .header h1 { font-size: 24px; color: #667eea; }
        .header-info { text-align: right; }
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #065f46;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            margin-left: 15px;
        }
        .status-badge.running { background: #065f46; color: #4ade80; }
        .status-badge.idle { background: #78350f; color: #fbbf24; }
        .status-badge.completing { background: #1e3a8a; color: #60a5fa; }
        .live-dot {
            width: 10px; height: 10px;
            background: #4ade80;
            border-radius: 50%;
            animation: blink 1s infinite;
        }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }
        .timestamp { color: #888; font-size: 12px; margin-top: 5px; }

        /* Progress Section */
        .progress-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .progress-card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .progress-card h3 {
            font-size: 12px;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 10px;
        }
        .progress-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .progress-value.lf { color: #4ade80; }
        .progress-value.oal { color: #60a5fa; }
        .progress-value.excel { color: #f59e0b; }
        .progress-value.overall { color: #a78bfa; }
        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .progress-fill.lf { background: linear-gradient(90deg, #22c55e, #4ade80); }
        .progress-fill.oal { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .progress-fill.excel { background: linear-gradient(90deg, #d97706, #f59e0b); }
        .progress-fill.overall { background: linear-gradient(90deg, #7c3aed, #a78bfa); }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .stat-label { font-size: 11px; color: #666; text-transform: uppercase; }
        .stat-value { font-size: 24px; font-weight: bold; margin-top: 5px; }
        .stat-value.success { color: #4ade80; }
        .stat-value.warning { color: #fbbf24; }
        .stat-value.error { color: #f87171; }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .card {
            background: rgba(30, 41, 59, 0.7);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h2 {
            font-size: 14px;
            text-transform: uppercase;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* Workers Grid */
        .workers-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .worker-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .worker-card.working {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }
        .worker-card.idle {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }
        .worker-card.inactive {
            border-color: #666;
            opacity: 0.5;
        }
        .worker-port {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }
        .worker-route {
            font-size: 11px;
            color: #4ade80;
            margin-top: 5px;
            font-weight: bold;
        }
        .worker-status {
            font-size: 10px;
            color: #888;
            margin-top: 3px;
            text-transform: uppercase;
        }

        /* Route Performance */
        .route-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .route-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            margin-bottom: 6px;
        }
        .route-name { font-weight: bold; color: #60a5fa; }
        .route-stats { font-size: 12px; color: #888; }
        .route-stats span { margin-left: 10px; }

        /* OAL Section */
        .oal-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .oal-stat {
            text-align: center;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        .oal-stat-value { font-size: 28px; font-weight: bold; }
        .oal-stat-label { font-size: 11px; color: #888; margin-top: 5px; }

        /* Config Section */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .config-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .config-label { color: #888; }
        .config-value { color: #fff; font-weight: bold; }

        /* Excel Files */
        .excel-list {
            max-height: 150px;
            overflow-y: auto;
            font-size: 11px;
        }
        .excel-item {
            padding: 5px 8px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 4px;
            margin-bottom: 4px;
            color: #f59e0b;
        }

        /* Queue Section */
        .queue-section {
            margin-top: 20px;
        }
        .queue-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .queue-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
        }
        .queue-route {
            padding: 4px 10px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 15px;
            font-size: 11px;
            color: #fca5a5;
        }
        .queue-route.completed {
            background: rgba(74, 222, 128, 0.2);
            border-color: rgba(74, 222, 128, 0.3);
            color: #4ade80;
        }
        .date-chunks {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .date-chunk {
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            text-align: center;
            font-size: 10px;
        }
        .date-chunk-id {
            font-weight: bold;
            color: #60a5fa;
            font-size: 14px;
        }
        .date-chunk-range { color: #888; margin-top: 3px; }
        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .queue-count {
            background: rgba(239, 68, 68, 0.2);
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 12px;
            color: #fca5a5;
        }

        /* Pending Route-Dates Section */
        .pending-routes-dates {
            margin-top: 20px;
        }
        .route-dates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .route-dates-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 12px;
            border-left: 3px solid #f87171;
        }
        .route-dates-card.completed {
            border-left-color: #4ade80;
            opacity: 0.6;
        }
        .route-dates-header {
            font-weight: bold;
            color: #60a5fa;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        .route-dates-count {
            font-size: 11px;
            color: #f87171;
            background: rgba(239, 68, 68, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
        }
        .route-dates-list {
            font-size: 11px;
            color: #ccc;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.6;
        }
        .route-dates-list .date-item {
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #667eea; border-radius: 3px; }

        /* =====================================================
           RESPONSIVE STYLES - Mobile & Tablet
           ===================================================== */

        /* Large tablets and small desktops */
        @media (max-width: 1200px) {
            .progress-section {
                grid-template-columns: repeat(2, 1fr);
            }
            .stats-row {
                grid-template-columns: repeat(3, 1fr);
            }
            .route-dates-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }

        /* Tablets */
        @media (max-width: 992px) {
            body { padding: 10px; }
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            .header h1 { font-size: 20px; }
            .header-info { text-align: center; }
            .main-grid {
                grid-template-columns: 1fr;
            }
            .queue-grid {
                grid-template-columns: 1fr;
            }
            .stats-row {
                grid-template-columns: repeat(3, 1fr);
            }
            .config-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Mobile phones */
        @media (max-width: 768px) {
            body { padding: 8px; }
            .header {
                padding: 12px 15px;
                border-radius: 10px;
            }
            .header h1 { font-size: 16px; }
            .progress-section {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .progress-card {
                padding: 12px;
            }
            .progress-value {
                font-size: 28px;
            }
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            .stat-card {
                padding: 10px;
            }
            .stat-value {
                font-size: 20px;
            }
            .card {
                padding: 15px;
                border-radius: 10px;
            }
            .card h2 {
                font-size: 12px;
            }
            .workers-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }
            .worker-card {
                padding: 8px;
            }
            .worker-port {
                font-size: 14px;
            }
            .worker-route {
                font-size: 9px;
            }
            .oal-stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }
            .oal-stat {
                padding: 10px;
            }
            .oal-stat-value {
                font-size: 22px;
            }
            .date-chunks {
                grid-template-columns: repeat(2, 1fr);
            }
            .route-dates-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .route-dates-card {
                padding: 10px;
            }
            .route-list {
                max-height: 200px;
            }
        }

        /* Small mobile phones */
        @media (max-width: 480px) {
            body { padding: 5px; }
            .header h1 { font-size: 14px; }
            .live-indicator {
                padding: 4px 10px;
                font-size: 10px;
            }
            #refresh-btn {
                padding: 6px 12px !important;
                font-size: 12px !important;
            }
            .progress-section {
                grid-template-columns: 1fr;
            }
            .progress-card {
                padding: 10px;
            }
            .progress-value {
                font-size: 24px;
            }
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
            .stat-value {
                font-size: 18px;
            }
            .stat-label {
                font-size: 9px;
            }
            .workers-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
            }
            .worker-card {
                padding: 6px;
            }
            .worker-port {
                font-size: 12px;
            }
            .worker-route {
                font-size: 8px;
            }
            .worker-status {
                font-size: 8px;
            }
            .oal-stat-value {
                font-size: 18px;
            }
            .oal-stat-label {
                font-size: 9px;
            }
            .route-dates-grid {
                grid-template-columns: 1fr;
            }
            .route-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .route-stats {
                font-size: 10px;
            }
            .route-stats span {
                margin-left: 5px;
            }
            .date-chunks {
                grid-template-columns: 1fr;
            }
            .queue-list {
                max-height: 150px;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            #refresh-btn {
                padding: 12px 24px !important;
                font-size: 14px !important;
            }
            .worker-card {
                padding: 12px;
            }
            ::-webkit-scrollbar {
                width: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>MARKET INSIGHTS DASHBOARD</h1>
        </div>
        <div class="header-info">
            <button id="refresh-btn" onclick="fetchStatus()" style="background:#667eea;color:#fff;border:none;padding:8px 20px;border-radius:20px;cursor:pointer;font-weight:bold;margin-right:15px">
                REFRESH
            </button>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>Auto-update: 10s</span>
            </div>
            <div id="connection-status" style="margin-top:5px;font-size:11px;color:#4ade80">● Connecting...</div>
            <div class="timestamp" id="timestamp">Loading...</div>
        </div>
    </div>

    <!-- Progress Bars -->
    <div class="progress-section">
        <div class="progress-card">
            <h3>Load Factor</h3>
            <div class="progress-value lf" id="lf-pct">0%</div>
            <div class="progress-bar"><div class="progress-fill lf" id="lf-bar" style="width: 0%"></div></div>
        </div>
        <div class="progress-card">
            <h3>OAL Data</h3>
            <div class="progress-value oal" id="oal-pct">0%</div>
            <div class="progress-bar"><div class="progress-fill oal" id="oal-bar" style="width: 0%"></div></div>
        </div>
        <div class="progress-card">
            <h3>Excel Output</h3>
            <div class="progress-value excel" id="excel-pct">0%</div>
            <div class="progress-bar"><div class="progress-fill excel" id="excel-bar" style="width: 0%"></div></div>
        </div>
        <div class="progress-card">
            <h3>Overall Progress</h3>
            <div class="progress-value overall" id="overall-pct">0%</div>
            <div class="progress-bar"><div class="progress-fill overall" id="overall-bar" style="width: 0%"></div></div>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-label">Routes Done</div>
            <div class="stat-value success" id="tasks-done">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Routes</div>
            <div class="stat-value" id="tasks-total">46</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Flights Analyzed</div>
            <div class="stat-value success" id="flights">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Excel Files</div>
            <div class="stat-value warning" id="excel-count">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Errors</div>
            <div class="stat-value" id="errors">0</div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">
        <!-- Workers Status -->
        <div class="card">
            <h2>Worker Ports - Live Status</h2>
            <div class="workers-grid" id="workers-grid">
                <!-- Filled by JS -->
            </div>
        </div>

        <!-- OAL Progress -->
        <div class="card">
            <h2>OAL Progress</h2>
            <div class="oal-stats">
                <div class="oal-stat">
                    <div class="oal-stat-value" id="oal-requests" style="color:#60a5fa">0</div>
                    <div class="oal-stat-label">Requests</div>
                </div>
                <div class="oal-stat">
                    <div class="oal-stat-value" id="oal-success" style="color:#4ade80">0</div>
                    <div class="oal-stat-label">Success</div>
                </div>
                <div class="oal-stat">
                    <div class="oal-stat-value" id="oal-errors" style="color:#f87171">0</div>
                    <div class="oal-stat-label">Errors</div>
                </div>
            </div>
        </div>

        <!-- Route Performance -->
        <div class="card">
            <h2>Route Performance (LF)</h2>
            <div class="route-list" id="route-list">
                <!-- Filled by JS -->
            </div>
        </div>

        <!-- Configuration -->
        <div class="card">
            <h2>Configuration</h2>
            <div class="config-grid" id="config-grid">
                <!-- Filled by JS -->
            </div>
            <h2 style="margin-top:20px">Excel Files Generated</h2>
            <div class="excel-list" id="excel-list">
                <!-- Filled by JS -->
            </div>
        </div>
    </div>

    <!-- Queue Section -->
    <div class="queue-section">
        <div class="queue-grid">
            <div class="card">
                <div class="queue-header">
                    <h2 style="margin:0;border:0;padding:0">Pending Routes (Waiting)</h2>
                    <span class="queue-count" id="pending-count">0 pending</span>
                </div>
                <div style="margin-bottom:10px;font-size:11px;color:#888">KSA → EGY</div>
                <div class="queue-list" id="queue-ksa-egy"></div>
                <div style="margin:10px 0;font-size:11px;color:#888">EGY → KSA</div>
                <div class="queue-list" id="queue-egy-ksa"></div>
            </div>
            <div class="card">
                <h2>Date Chunks (12 Total)</h2>
                <div class="date-chunks" id="date-chunks"></div>
                <h2 style="margin-top:15px">All Routes Status</h2>
                <div class="queue-list" id="all-routes-status" style="max-height:150px"></div>
            </div>
        </div>
    </div>

    <!-- Smart Queue Section -->
    <div class="pending-routes-dates">
        <!-- Summary Bar -->
        <div class="card" style="margin-top:20px;background:linear-gradient(135deg,rgba(102,126,234,0.2),rgba(118,75,162,0.2))">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px">
                <div>
                    <h2 style="margin:0;border:0;padding:0;font-size:18px">Queue Status</h2>
                    <div id="total-pending-dates" style="color:#888;font-size:12px;margin-top:5px">Loading...</div>
                </div>
                <div style="display:flex;gap:20px">
                    <div style="text-align:center">
                        <div id="active-routes-count" style="font-size:24px;font-weight:bold;color:#4ade80">0</div>
                        <div style="font-size:10px;color:#888">ACTIVE</div>
                    </div>
                    <div style="text-align:center">
                        <div id="pending-routes-count" style="font-size:24px;font-weight:bold;color:#fbbf24">0</div>
                        <div style="font-size:10px;color:#888">PENDING</div>
                    </div>
                    <div style="text-align:center">
                        <div id="completed-routes-count" style="font-size:24px;font-weight:bold;color:#60a5fa">0</div>
                        <div style="font-size:10px;color:#888">DONE</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabbed View -->
        <div class="card" style="margin-top:10px">
            <div style="display:flex;gap:10px;margin-bottom:15px">
                <button class="tab-btn active" onclick="showTab('pending')" id="tab-pending">Pending Routes</button>
                <button class="tab-btn" onclick="showTab('completed')" id="tab-completed">Completed Routes</button>
                <button class="tab-btn" onclick="showTab('all')" id="tab-all">All Routes</button>
            </div>
            <div class="route-dates-grid" id="route-dates-grid">
                <!-- Filled by JS -->
            </div>
        </div>
    </div>

    <style>
        .tab-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #888;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.2); }
        .tab-btn.active { background: #667eea; color: #fff; }
    </style>

    <script>
        const WORKER_PORTS = [9222, 9223, 9224, 9225, 9226, 9227, 9232, 9233, 9234];
        let currentTab = 'pending';
        let lastData = null;

        function showTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            if (lastData) renderQueue(lastData);
        }

        function renderQueue(data) {
            const queue = data.queue || {};
            const pendingRouteDates = queue.pending_route_dates || {};
            const allRoutes = queue.all_routes || [];
            const totalDates = queue.total_dates || 105;
            const workers = data.workers || {};

            // Get active routes from workers
            const activeRoutes = new Set();
            Object.values(workers).forEach(w => {
                if (w.status === 'working' && w.active_route) {
                    activeRoutes.add(w.active_route);
                }
            });

            // Categorize routes
            const pendingRoutes = [];
            const completedRoutes = [];
            let totalPendingDates = 0;
            let totalCompletedDates = 0;

            allRoutes.forEach(route => {
                const dates = pendingRouteDates[route] || [];
                const pendingCount = dates.length;
                const completedCount = totalDates - pendingCount;
                totalPendingDates += pendingCount;
                totalCompletedDates += completedCount;

                const routeData = { route, dates, pendingCount, completedCount, isActive: activeRoutes.has(route) };
                if (pendingCount === 0) {
                    completedRoutes.push(routeData);
                } else {
                    pendingRoutes.push(routeData);
                }
            });

            // Update counts
            document.getElementById('active-routes-count').textContent = activeRoutes.size;
            document.getElementById('pending-routes-count').textContent = pendingRoutes.length;
            document.getElementById('completed-routes-count').textContent = completedRoutes.length;
            document.getElementById('total-pending-dates').textContent =
                `${totalPendingDates.toLocaleString()} dates pending | ${totalCompletedDates.toLocaleString()} done | Total: ${(totalDates * allRoutes.length).toLocaleString()}`;

            // Filter based on current tab
            let routesToShow = [];
            if (currentTab === 'pending') {
                routesToShow = pendingRoutes;
            } else if (currentTab === 'completed') {
                routesToShow = completedRoutes;
            } else {
                routesToShow = [...pendingRoutes, ...completedRoutes];
            }

            // Sort: active first, then by pending count
            routesToShow.sort((a, b) => {
                if (a.isActive && !b.isActive) return -1;
                if (!a.isActive && b.isActive) return 1;
                return b.pendingCount - a.pendingCount;
            });

            // Render
            let html = '';
            routesToShow.forEach(({ route, dates, pendingCount, completedCount, isActive }) => {
                const isCompleted = pendingCount === 0;
                const progressPct = ((completedCount / totalDates) * 100).toFixed(0);
                const displayDates = dates.slice(0, 20);
                const hasMore = dates.length > 20;

                html += `
                    <div class="route-dates-card ${isCompleted ? 'completed' : ''}" style="${isActive ? 'border-left-color:#4ade80;background:rgba(74,222,128,0.1)' : ''}">
                        <div class="route-dates-header">
                            <span>${route} ${isActive ? '<span style="color:#4ade80;font-size:10px">● ACTIVE</span>' : ''}</span>
                            <span class="route-dates-count" style="${isCompleted ? 'background:rgba(74,222,128,0.2);color:#4ade80' : ''}">${isCompleted ? 'DONE' : pendingCount + ' left'}</span>
                        </div>
                        <div style="font-size:10px;color:#888;margin-bottom:5px">
                            <span style="color:${progressPct > 50 ? '#4ade80' : '#fbbf24'}">${completedCount}/${totalDates}</span> (${progressPct}%)
                        </div>
                        ${!isCompleted ? `
                            <div class="route-dates-list">
                                ${displayDates.map(d => `<div class="date-item">${d}</div>`).join('')}
                                ${hasMore ? `<div class="date-item" style="color:#667eea;font-style:italic">+${dates.length - 20} more dates</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            if (routesToShow.length === 0) {
                html = `<div style="text-align:center;padding:30px;color:#888">
                    ${currentTab === 'pending' ? 'All routes completed!' : currentTab === 'completed' ? 'No completed routes yet' : 'No routes'}
                </div>`;
            }

            document.getElementById('route-dates-grid').innerHTML = html;
        }

        function updateDashboard(data) {
            lastData = data;
            // Timestamp
            document.getElementById('timestamp').textContent =
                'Last Update: ' + new Date(data.timestamp).toLocaleTimeString();

            // Progress bars
            document.getElementById('lf-pct').textContent = data.progress.lf.toFixed(1) + '%';
            document.getElementById('lf-bar').style.width = data.progress.lf + '%';

            document.getElementById('oal-pct').textContent = data.progress.oal.toFixed(1) + '%';
            document.getElementById('oal-bar').style.width = data.progress.oal + '%';

            document.getElementById('excel-pct').textContent = data.progress.excel.toFixed(1) + '%';
            document.getElementById('excel-bar').style.width = data.progress.excel + '%';

            document.getElementById('overall-pct').textContent = data.progress.overall.toFixed(1) + '%';
            document.getElementById('overall-bar').style.width = data.progress.overall + '%';

            // Stats
            document.getElementById('tasks-done').textContent = data.routes_completed || 0;
            document.getElementById('tasks-total').textContent = data.total_routes || 46;
            document.getElementById('flights').textContent = data.flights_analyzed;
            document.getElementById('excel-count').textContent = data.excel_count;

            const errorsEl = document.getElementById('errors');
            errorsEl.textContent = data.errors;
            errorsEl.className = 'stat-value ' + (data.errors > 0 ? 'error' : 'success');

            // Workers
            let workersHtml = '';
            WORKER_PORTS.forEach(port => {
                const worker = data.workers[port] || {status: 'inactive', active_route: null};
                workersHtml += `
                    <div class="worker-card ${worker.status}">
                        <div class="worker-port">${port}</div>
                        <div class="worker-route">${worker.active_route || '-'}</div>
                        <div class="worker-status">${worker.status}</div>
                    </div>
                `;
            });
            document.getElementById('workers-grid').innerHTML = workersHtml;

            // OAL Stats
            document.getElementById('oal-requests').textContent = data.oal.requests;
            document.getElementById('oal-success').textContent = data.oal.success;
            document.getElementById('oal-errors').textContent = data.oal.errors;

            // Route Performance
            let routeHtml = '';
            for (const [route, perf] of Object.entries(data.route_performance || {})) {
                routeHtml += `
                    <div class="route-item">
                        <span class="route-name">${route}</span>
                        <span class="route-stats">
                            <span>${perf.count} req</span>
                            <span>${perf.avg}s avg</span>
                            <span>P95: ${perf.p95}s</span>
                        </span>
                    </div>
                `;
            }
            document.getElementById('route-list').innerHTML = routeHtml || '<div style="color:#666">Loading routes...</div>';

            // Config
            const config = data.config || {};
            document.getElementById('config-grid').innerHTML = `
                <div class="config-item"><span class="config-label">Mode</span><span class="config-value">${config.mode} (${config.ports} ports)</span></div>
                <div class="config-item"><span class="config-label">Routes</span><span class="config-value">${config.routes}</span></div>
                <div class="config-item"><span class="config-label">Chunks</span><span class="config-value">${config.chunks}</span></div>
                <div class="config-item"><span class="config-label">Date Range</span><span class="config-value">${config.date_range}</span></div>
                <div class="config-item"><span class="config-label">OAL Workers</span><span class="config-value">${config.oal_workers}</span></div>
                <div class="config-item"><span class="config-label">OAL Passes</span><span class="config-value">${config.oal_passes}</span></div>
            `;

            // Excel Files
            let excelHtml = '';
            (data.excel_files || []).forEach(f => {
                excelHtml += `<div class="excel-item">${f}</div>`;
            });
            document.getElementById('excel-list').innerHTML = excelHtml || '<div style="color:#666">No files yet</div>';

            // Queue - Pending Routes
            const queue = data.queue || {};
            const completedRoutes = new Set(Object.keys(data.route_performance || {}));

            // Pending count
            document.getElementById('pending-count').textContent = (queue.pending_count || 0) + ' pending';

            // KSA to EGY pending
            let ksaHtml = '';
            (queue.ksa_to_egy_pending || []).forEach(r => {
                ksaHtml += `<span class="queue-route">${r}</span>`;
            });
            document.getElementById('queue-ksa-egy').innerHTML = ksaHtml || '<span style="color:#4ade80;font-size:11px">All completed!</span>';

            // EGY to KSA pending
            let egyHtml = '';
            (queue.egy_to_ksa_pending || []).forEach(r => {
                egyHtml += `<span class="queue-route">${r}</span>`;
            });
            document.getElementById('queue-egy-ksa').innerHTML = egyHtml || '<span style="color:#4ade80;font-size:11px">All completed!</span>';

            // Date chunks
            let chunksHtml = '';
            (queue.date_chunks || []).forEach(chunk => {
                chunksHtml += `
                    <div class="date-chunk">
                        <div class="date-chunk-id">#${chunk.id}</div>
                        <div class="date-chunk-range">${chunk.dates}</div>
                    </div>
                `;
            });
            document.getElementById('date-chunks').innerHTML = chunksHtml;

            // All routes status (completed vs pending)
            let allRoutesHtml = '';
            (queue.all_routes || []).forEach(r => {
                const isCompleted = completedRoutes.has(r);
                allRoutesHtml += `<span class="queue-route ${isCompleted ? 'completed' : ''}">${r}</span>`;
            });
            document.getElementById('all-routes-status').innerHTML = allRoutesHtml;

            // Render queue with smart tabs
            renderQueue(data);
        }

        // API URL - change this to your localtunnel URL
        const API_BASE = 'https://refertilizable-nonevasively-lavelle.ngrok-free.dev';

        async function fetchStatus() {
            try {
                const response = await fetch(API_BASE + '/status', {
                    headers: { 'ngrok-skip-browser-warning': 'true' }
                });
                const data = await response.json();
                updateDashboard(data);
                document.getElementById('connection-status').textContent = '● Connected';
                document.getElementById('connection-status').style.color = '#4ade80';
            } catch (e) {
                console.error('Fetch error:', e);
                document.getElementById('connection-status').textContent = '● Disconnected';
                document.getElementById('connection-status').style.color = '#f87171';
            }
        }

        // Initial fetch and interval (10 seconds)
        fetchStatus();
        setInterval(fetchStatus, 10000);
    </script>
</body>
</html>
